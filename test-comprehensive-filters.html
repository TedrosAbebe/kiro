<!DOCTYPE html>
<html>
<head>
    <title>Ethiopian Home Broker - Comprehensive Property Filters</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9fafb; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #059669, #10b981); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .filters-section { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .category-card { border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .category-card:hover { border-color: #059669; background: #f0fdf4; }
        .category-card.active { border-color: #059669; background: #f0fdf4; }
        .category-icon { font-size: 32px; margin-bottom: 10px; }
        .category-title { font-weight: bold; color: #374151; }
        .subcategory-section { margin-top: 20px; }
        .subcategory-title { font-size: 18px; font-weight: bold; color: #374151; margin-bottom: 15px; }
        .property-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .property-type { border: 1px solid #d1d5db; border-radius: 6px; padding: 12px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .property-type:hover { border-color: #3b82f6; background: #eff6ff; }
        .property-type.active { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; }
        .search-section { display: grid; grid-template-columns: 1fr 200px 200px; gap: 15px; margin-bottom: 20px; }
        .search-input, .filter-select { padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; }
        .active-filters { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .filter-tag { background: #3b82f6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin: 2px; display: inline-block; }
        .filter-tag .remove { margin-left: 8px; cursor: pointer; font-weight: bold; }
        .results-section { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .property-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .property-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; background: white; }
        .property-price { font-size: 20px; font-weight: bold; color: #059669; margin-bottom: 10px; }
        .property-location { color: #6b7280; margin-bottom: 8px; }
        .property-type { background: #e5e7eb; padding: 4px 8px; border-radius: 12px; font-size: 12px; display: inline-block; }
        .contact-buttons { margin-top: 15px; display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .stats { background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        @media (max-width: 768px) {
            .search-section { grid-template-columns: 1fr; }
            .category-grid { grid-template-columns: repeat(2, 1fr); }
            .property-types { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Ethiopian Home Broker</h1>
            <p>Comprehensive Property Search with Professional Filtering</p>
        </div>

        <div class="filters-section">
            <h2>üîç Property Categories</h2>
            <div class="category-grid" id="categoryGrid">
                <!-- Categories will be populated by JavaScript -->
            </div>

            <div id="subcategorySection" class="subcategory-section" style="display: none;">
                <h3 class="subcategory-title">Select Property Type</h3>
                <div id="subcategoryContent">
                    <!-- Subcategories will be populated by JavaScript -->
                </div>
            </div>

            <div class="search-section">
                <input type="text" id="searchInput" class="search-input" placeholder="Search properties by title or area...">
                <select id="citySelect" class="filter-select">
                    <option value="">All Cities</option>
                    <option value="Addis Ababa">Addis Ababa</option>
                    <option value="Dire Dawa">Dire Dawa</option>
                    <option value="Bahir Dar">Bahir Dar</option>
                    <option value="Hawassa">Hawassa</option>
                    <option value="Mekelle">Mekelle</option>
                </select>
                <select id="priceSelect" class="filter-select">
                    <option value="">Any Price</option>
                    <optgroup label="Rental Prices (Monthly)">
                        <option value="0-5000">< 5,000 ETB</option>
                        <option value="5000-10000">5,000 - 10,000 ETB</option>
                        <option value="10000-20000">10,000 - 20,000 ETB</option>
                        <option value="20000-30000">20,000 - 30,000 ETB</option>
                        <option value="30000-50000">30,000 - 50,000 ETB</option>
                    </optgroup>
                    <optgroup label="Sale Prices">
                        <option value="100000-500000">100K - 500K ETB</option>
                        <option value="500000-1000000">500K - 1M ETB</option>
                        <option value="1000000-2000000">1M - 2M ETB</option>
                        <option value="2000000-5000000">2M - 5M ETB</option>
                        <option value="5000000-10000000">5M - 10M ETB</option>
                        <option value="10000000+">10M+ ETB</option>
                    </optgroup>
                </select>
            </div>

            <div id="activeFilters" class="active-filters" style="display: none;">
                <strong>üè∑Ô∏è Active Filters:</strong>
                <div id="filterTags"></div>
                <button onclick="clearAllFilters()" style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                    Clear All Filters
                </button>
            </div>
        </div>

        <div class="results-section">
            <div id="stats" class="stats">
                <strong>üìä Results:</strong> <span id="resultCount">Loading...</span>
            </div>

            <div id="propertiesContainer">
                <div class="loading">üîÑ Loading properties...</div>
            </div>
        </div>
    </div>

    <script>
        // Comprehensive property categories
        const propertyCategories = {
            sale: {
                title: 'For Sale (·ã®·àö·à∏·å• ·äï·â•·à®·âµ)',
                icon: 'üè°',
                subcategories: {
                    residential: {
                        title: 'Residential',
                        types: [
                            { key: 'house_sale', label: 'House' },
                            { key: 'villa_sale', label: 'Villa' },
                            { key: 'g1_house_sale', label: 'G+1 House' },
                            { key: 'g2_house_sale', label: 'G+2 House' },
                            { key: 'townhouse_sale', label: 'Townhouse' },
                            { key: 'apartment_sale', label: 'Apartment' },
                            { key: 'condominium_sale', label: 'Condominium' },
                            { key: 'studio_sale', label: 'Studio Apartment' },
                            { key: 'serviced_apartment_sale', label: 'Serviced Apartment' },
                            { key: 'duplex_sale', label: 'Duplex/Penthouse' }
                        ]
                    },
                    commercial: {
                        title: 'Commercial',
                        types: [
                            { key: 'shop_sale', label: 'Shop' },
                            { key: 'office_sale', label: 'Office' },
                            { key: 'commercial_building_sale', label: 'Commercial Building' },
                            { key: 'mall_space_sale', label: 'Mall Space' },
                            { key: 'showroom_sale', label: 'Showroom' }
                        ]
                    },
                    land: {
                        title: 'Land',
                        types: [
                            { key: 'residential_land', label: 'Residential Land' },
                            { key: 'commercial_land', label: 'Commercial Land' },
                            { key: 'agricultural_land', label: 'Agricultural Land' },
                            { key: 'industrial_land', label: 'Industrial Land' },
                            { key: 'vacant_plot', label: 'Plot (Vacant Land)' }
                        ]
                    }
                }
            },
            rent: {
                title: 'For Rent (·àà·ä™·à´·ã≠)',
                icon: 'üè†',
                subcategories: {
                    residential: {
                        title: 'Residential',
                        types: [
                            { key: 'house_rent', label: 'House for Rent' },
                            { key: 'villa_rent', label: 'Villa' },
                            { key: 'family_house_rent', label: 'Family House' },
                            { key: 'apartment_rent', label: 'Apartment for Rent' },
                            { key: 'condominium_rent', label: 'Condominium' },
                            { key: 'studio_rent', label: 'Studio' },
                            { key: 'furnished_apartment', label: 'Furnished Apartment' },
                            { key: 'unfurnished_apartment', label: 'Unfurnished Apartment' },
                            { key: 'room_rent', label: 'Room for Rent' },
                            { key: 'shared_apartment', label: 'Shared Apartment' }
                        ]
                    },
                    commercial: {
                        title: 'Commercial',
                        types: [
                            { key: 'shop_rent', label: 'Shop for Rent' },
                            { key: 'office_rent', label: 'Office for Rent' },
                            { key: 'warehouse_rent', label: 'Warehouse' },
                            { key: 'workshop_rent', label: 'Workshop' },
                            { key: 'commercial_space_rent', label: 'Commercial Space' }
                        ]
                    }
                }
            },
            lease: {
                title: 'For Lease (Long-Term)',
                icon: 'üìã',
                subcategories: {
                    longterm: {
                        title: 'Long-Term Lease',
                        types: [
                            { key: 'land_lease', label: 'Land Lease' },
                            { key: 'commercial_building_lease', label: 'Commercial Building Lease' },
                            { key: 'factory_lease', label: 'Factory/Industrial Lease' },
                            { key: 'warehouse_lease', label: 'Warehouse Lease' },
                            { key: 'office_lease', label: 'Office Lease' }
                        ]
                    }
                }
            },
            shortterm: {
                title: 'Short-Term/Daily Rent',
                icon: 'üè®',
                subcategories: {
                    daily: {
                        title: 'Daily Rent',
                        types: [
                            { key: 'furnished_daily', label: 'Furnished Apartment (Daily)' },
                            { key: 'guest_house', label: 'Guest House' },
                            { key: 'vacation_home', label: 'Vacation Home' },
                            { key: 'hotel_apartment', label: 'Hotel Apartment' },
                            { key: 'airbnb_style', label: 'Airbnb-style Property' }
                        ]
                    }
                }
            },
            special: {
                title: 'Special Property Types',
                icon: '‚≠ê',
                subcategories: {
                    luxury: {
                        title: 'Special Properties',
                        types: [
                            { key: 'luxury_property', label: 'Luxury Property' },
                            { key: 'new_development', label: 'New Development' },
                            { key: 'off_plan', label: 'Off-Plan Property' },
                            { key: 'gated_community', label: 'Gated Community' },
                            { key: 'smart_home', label: 'Smart Home' },
                            { key: 'investment_property', label: 'Investment Property' }
                        ]
                    }
                }
            }
        };

        let selectedCategory = '';
        let selectedType = '';
        let allProperties = [];

        function initializeCategories() {
            const categoryGrid = document.getElementById('categoryGrid');
            categoryGrid.innerHTML = '';

            Object.entries(propertyCategories).forEach(([key, category]) => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'category-card';
                categoryCard.onclick = () => selectCategory(key);
                categoryCard.innerHTML = `
                    <div class="category-icon">${category.icon}</div>
                    <div class="category-title">${category.title}</div>
                `;
                categoryGrid.appendChild(categoryCard);
            });
        }

        function selectCategory(categoryKey) {
            selectedCategory = categoryKey;
            selectedType = '';
            
            // Update category selection visual
            document.querySelectorAll('.category-card').forEach(card => card.classList.remove('active'));
            event.target.closest('.category-card').classList.add('active');
            
            // Show subcategories
            showSubcategories(categoryKey);
            updateActiveFilters();
        }

        function showSubcategories(categoryKey) {
            const subcategorySection = document.getElementById('subcategorySection');
            const subcategoryContent = document.getElementById('subcategoryContent');
            
            subcategorySection.style.display = 'block';
            subcategoryContent.innerHTML = '';

            const category = propertyCategories[categoryKey];
            Object.entries(category.subcategories).forEach(([subKey, subcategory]) => {
                const subcategoryDiv = document.createElement('div');
                subcategoryDiv.innerHTML = `
                    <h4 style="font-weight: bold; color: #374151; margin: 15px 0 10px 0;">${subcategory.title}</h4>
                    <div class="property-types">
                        ${subcategory.types.map(type => `
                            <div class="property-type" onclick="selectPropertyType('${type.key}')">
                                ${type.label}
                            </div>
                        `).join('')}
                    </div>
                `;
                subcategoryContent.appendChild(subcategoryDiv);
            });
        }

        function selectPropertyType(typeKey) {
            selectedType = typeKey;
            
            // Update property type selection visual
            document.querySelectorAll('.property-type').forEach(type => type.classList.remove('active'));
            event.target.classList.add('active');
            
            updateActiveFilters();
            loadProperties();
        }

        function updateActiveFilters() {
            const activeFiltersDiv = document.getElementById('activeFilters');
            const filterTagsDiv = document.getElementById('filterTags');
            
            const filters = [];
            
            if (selectedCategory) {
                filters.push({
                    label: propertyCategories[selectedCategory].title,
                    remove: () => {
                        selectedCategory = '';
                        selectedType = '';
                        document.getElementById('subcategorySection').style.display = 'none';
                        document.querySelectorAll('.category-card').forEach(card => card.classList.remove('active'));
                        updateActiveFilters();
                        loadProperties();
                    }
                });
            }
            
            if (selectedType) {
                // Find type label
                let typeLabel = selectedType;
                for (const category of Object.values(propertyCategories)) {
                    for (const subcategory of Object.values(category.subcategories)) {
                        const type = subcategory.types.find(t => t.key === selectedType);
                        if (type) {
                            typeLabel = type.label;
                            break;
                        }
                    }
                }
                
                filters.push({
                    label: typeLabel,
                    remove: () => {
                        selectedType = '';
                        document.querySelectorAll('.property-type').forEach(type => type.classList.remove('active'));
                        updateActiveFilters();
                        loadProperties();
                    }
                });
            }

            const search = document.getElementById('searchInput').value;
            const city = document.getElementById('citySelect').value;
            const price = document.getElementById('priceSelect').value;

            if (search) filters.push({ label: `Search: "${search}"`, remove: () => { document.getElementById('searchInput').value = ''; updateActiveFilters(); loadProperties(); } });
            if (city) filters.push({ label: `City: ${city}`, remove: () => { document.getElementById('citySelect').value = ''; updateActiveFilters(); loadProperties(); } });
            if (price) filters.push({ label: `Price: ${document.getElementById('priceSelect').selectedOptions[0].text}`, remove: () => { document.getElementById('priceSelect').value = ''; updateActiveFilters(); loadProperties(); } });

            if (filters.length > 0) {
                activeFiltersDiv.style.display = 'block';
                filterTagsDiv.innerHTML = filters.map(filter => `
                    <span class="filter-tag">
                        ${filter.label}
                        <span class="remove" onclick="event.stopPropagation(); (${filter.remove})()">√ó</span>
                    </span>
                `).join('');
            } else {
                activeFiltersDiv.style.display = 'none';
            }
        }

        function clearAllFilters() {
            selectedCategory = '';
            selectedType = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('citySelect').value = '';
            document.getElementById('priceSelect').value = '';
            document.getElementById('subcategorySection').style.display = 'none';
            document.querySelectorAll('.category-card').forEach(card => card.classList.remove('active'));
            document.querySelectorAll('.property-type').forEach(type => type.classList.remove('active'));
            updateActiveFilters();
            loadProperties();
        }

        async function loadProperties() {
            try {
                const search = document.getElementById('searchInput').value;
                const city = document.getElementById('citySelect').value;
                const price = document.getElementById('priceSelect').value;
                
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (city) params.append('city', city);
                if (selectedType) params.append('type', selectedType);
                
                if (price) {
                    if (price.includes('+')) {
                        const minPrice = price.replace('+', '');
                        params.append('minPrice', minPrice);
                    } else if (price.includes('-')) {
                        const [min, max] = price.split('-');
                        params.append('minPrice', min);
                        params.append('maxPrice', max);
                    }
                }
                
                const queryString = params.toString();
                const url = `/api/properties-public${queryString ? '?' + queryString : ''}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.properties) {
                    allProperties = data.properties;
                    displayProperties(data.properties);
                    updateStats(data.properties);
                } else {
                    document.getElementById('propertiesContainer').innerHTML = 
                        '<div class="loading">‚ùå Error loading properties: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('propertiesContainer').innerHTML = 
                    '<div class="loading">‚ùå Error: ' + error.message + '</div>';
            }
        }

        function displayProperties(properties) {
            if (properties.length === 0) {
                document.getElementById('propertiesContainer').innerHTML = 
                    '<div class="loading">üè† No properties found matching your criteria</div>';
                return;
            }
            
            let html = '<div class="property-grid">';
            
            properties.forEach(property => {
                html += `
                    <div class="property-card">
                        <h3>${property.title}</h3>
                        <div class="property-price">${new Intl.NumberFormat().format(property.price)} ETB</div>
                        <div class="property-location">üìç ${property.area}, ${property.city}</div>
                        <div class="property-type">${property.type}</div>
                        <div style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                            <strong>Size:</strong> ${property.size} m¬≤ <br>
                            <strong>Owner:</strong> ${property.owner_name || 'Unknown'} <br>
                            <strong>Contact:</strong> ${property.phone_number}
                        </div>
                        <div class="contact-buttons">
                            <button class="btn btn-primary" onclick="viewDetails('${property.id}')">
                                üëÅÔ∏è View Details
                            </button>
                            <button class="btn btn-success" onclick="contactBroker('${property.whatsapp_number}', '${property.title}')">
                                üí¨ WhatsApp
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('propertiesContainer').innerHTML = html;
        }

        function updateStats(properties) {
            const count = properties.length;
            const totalValue = properties.reduce((sum, prop) => sum + prop.price, 0);
            const avgPrice = count > 0 ? totalValue / count : 0;
            
            document.getElementById('resultCount').innerHTML = `
                ${count} properties found | 
                Average Price: ${new Intl.NumberFormat().format(avgPrice)} ETB
            `;
        }

        function viewDetails(propertyId) {
            window.open(`/property/${propertyId}`, '_blank');
        }

        function contactBroker(whatsappNumber, title) {
            const cleanNumber = whatsappNumber.replace(/[\+\s-]/g, '');
            const message = encodeURIComponent(`Hello, I'm interested in the property: ${title}. Can you provide more details?`);
            window.open(`https://wa.me/${cleanNumber}?text=${message}`, '_blank');
        }

        // Initialize the page
        initializeCategories();
        loadProperties();

        // Add event listeners for real-time filtering
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                updateActiveFilters();
                loadProperties();
            }, 500);
        });

        document.getElementById('citySelect').addEventListener('change', () => {
            updateActiveFilters();
            loadProperties();
        });

        document.getElementById('priceSelect').addEventListener('change', () => {
            updateActiveFilters();
            loadProperties();
        });
    </script>
</body>
</html>